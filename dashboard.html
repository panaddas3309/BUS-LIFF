<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

<!-- Loading Screen -->
<div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
  <img src="https://www.gstatic.com/images/branding/googlelogo/2x/googlelogo_light_color_92x30dp.png" alt="Loading" class="mb-4">
  <p class="text-gray-500 text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
</div>

<!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ dashboard ‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á loading -->
<div id="dashboardContent" style="display:none;">
  <!-- ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå + Tabs + Content ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° -->
</div>

<script>
async function initializeDashboard() {
  const loading = document.getElementById('loadingScreen');
  const content = document.getElementById('dashboardContent');

  try {
    await liff.init({ liffId: "YOUR_LIFF_ID" });
    if (!liff.isLoggedIn()) liff.login();

    const profile = await liff.getProfile();
    const lineUserId = profile.userId;

    // Fetch ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Apps Script
    const res = await fetch('https://script.google.com/macros/s/AKfycbweaBqP-v0PkITA_TAhRlho-UGIqP_3A4pkk8MBSTsy-Lx9u-Rh1ChCZLn7vSsXXaim/exec?lineUserId='+lineUserId);
    const data = await res.json();

    if (!data.found) {
      window.location.href = 'LineID_Registration.html';
      return;
    }

    const balanceData = data.balance;
    const recordsData = data.records;

    // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå + ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô + ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à
    document.getElementById('profileImage').src = profile.pictureUrl;
    document.getElementById('profileName').textContent = balanceData[1]; // ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å Column B
    document.getElementById('employeeCode').textContent = '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ' + balanceData[0];
    document.getElementById('motivationMessage').textContent = getRandomMotivation();

    // Render Tabs
    renderRemainTab(balanceData);
    renderUsedTab(recordsData);

    // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ dashboard ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô loading
    loading.style.display = 'none';
    content.style.display = 'block';

  } catch (e) {
    console.error(e);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    loading.style.display = 'none';
  }
}

initializeDashboard();
</script>
let balanceData = null;
let recordsData = null;

async function initializeDashboard() {
  await liff.init({ liffId: "2007956727-rbZz9a0z" });
  if (!liff.isLoggedIn()) liff.login();
  const profile = await liff.getProfile();
  const lineUserId = profile.userId;
  document.getElementById('profileName').textContent = profile.displayName;

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Apps Script
  try {
    const res = await fetch('https://script.google.com/macros/s/AKfycbweaBqP-v0PkITA_TAhRlho-UGIqP_3A4pkk8MBSTsy-Lx9u-Rh1ChCZLn7vSsXXaim/exec?lineUserId='+lineUserId);
    const data = await res.json();

    if (!data.found) {
      window.location.href = 'LineID_Registration.html';
      return;
    }

    // ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    balanceData = data.balance; // A-F
    recordsData = data.records; // A,B,D,E,F,G

    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    document.getElementById('employeeCode').textContent = '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ' + balanceData[0];

    // Render Tabs
    renderRemainTab(balanceData);
    renderUsedTab(recordsData);

    document.getElementById('profileCard').style.display = 'block';

  } catch(e) {
    console.error(e);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
  }
}

function renderRemainTab(data) {
  const remain = document.getElementById('remain');
  remain.innerHTML = '';

  const types = [
    {name:'‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô', emoji:'üå¥', value:data[2]}, // C
    {name:'‡∏•‡∏≤‡∏Å‡∏¥‡∏à', emoji:'üìÑ', value:data[3]},    // D
    {name:'‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', emoji:'ü§í', value:data[4]},   // E
    {name:'‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô', emoji:'‚ùå', value:data[5]}   // F
  ];

  types.forEach(t => {
    const div = document.createElement('div');
    div.className = "flex justify-between items-center bg-white p-4 rounded-2xl shadow hover:scale-102 transition-transform";
    div.innerHTML = `<div class="flex items-center space-x-3"><span class="text-xl">${t.emoji}</span><span class="font-medium text-gray-700">${t.name}</span></div><span class="text-green-600 font-bold text-lg">${t.value} ‡∏ß‡∏±‡∏ô</span>`;
    remain.appendChild(div);
  });
}

function renderUsedTab(data) {
  const used = document.getElementById('used');
  used.innerHTML = '';

  const types = [
    {name:'‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô', emoji:'üå¥', value:data[2]}, // D
    {name:'‡∏•‡∏≤‡∏Å‡∏¥‡∏à', emoji:'üìÑ', value:data[3]},    // E
    {name:'‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', emoji:'ü§í', value:data[4]},   // F
    {name:'‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô', emoji:'‚ùå', value:data[5]}   // G
  ];

  types.forEach(t => {
    const div = document.createElement('div');
    div.className = "flex justify-between items-center bg-white p-4 rounded-2xl shadow hover:scale-102 transition-transform";
    div.innerHTML = `<div class="flex items-center space-x-3"><span class="text-xl">${t.emoji}</span><span class="font-medium text-gray-700">${t.name}</span></div><span class="text-red-600 font-bold text-lg">${t.value} ‡∏ß‡∏±‡∏ô</span>`;
    used.appendChild(div);
  });
}

function showTab(tab) {
  const remain = document.getElementById("remain");
  const used = document.getElementById("used");
  const tabRemain = document.getElementById("tab-remain");
  const tabUsed = document.getElementById("tab-used");

  if (tab === "remain") {
    remain.classList.remove("hidden");
    used.classList.add("hidden");
    tabRemain.classList.add("bg-white","text-blue-600","shadow-md");
    tabRemain.classList.remove("bg-gray-200","text-gray-500");
    tabUsed.classList.add("bg-gray-200","text-gray-500");
    tabUsed.classList.remove("bg-white","text-blue-600","shadow-md");
  } else {
    remain.classList.add("hidden");
    used.classList.remove("hidden");
    tabUsed.classList.add("bg-white","text-blue-600","shadow-md");
    tabUsed.classList.remove("bg-gray-200","text-gray-500");
    tabRemain.classList.add("bg-gray-200","text-gray-500");
    tabRemain.classList.remove("bg-white","text-blue-600","shadow-md");
  }
}

initializeDashboard();
</script>
</body>
</html>
