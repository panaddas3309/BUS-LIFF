<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>
body { font-family: 'Inter', sans-serif; }
@keyframes spin {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}
</style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

<!-- Loading Screen -->
<div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center space-y-4">
  <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
  <p class="text-gray-600 text-lg font-medium">กำลังโหลดข้อมูล...</p>
</div>

<!-- Dashboard Content -->
<div id="dashboardContent" class="opacity-0 transition-opacity duration-500">

  <!-- โปรไฟล์ + ข้อความกำลังใจ -->
  <div class="bg-gradient-to-r from-blue-100 to-blue-50 rounded-2xl shadow-md p-6 mb-6 flex items-center space-x-4">
    <img src="" alt="โปรไฟล์" id="profileImage" class="w-16 h-16 rounded-full border-2 border-blue-500"/>
    <div>
      <p class="text-gray-600 text-sm">สวัสดีค่ะ</p>
      <p class="font-bold text-xl text-gray-800" id="profileName"></p>
      <p class="text-gray-500 text-sm" id="employeeCode"></p>
      <p class="text-blue-600 font-medium text-sm mt-1" id="motivationMessage"></p>
    </div>
  </div>

  <!-- Tabs -->
  <div class="flex justify-center mb-6 space-x-3">
    <button id="tab-remain" class="px-6 py-2 rounded-full bg-white text-blue-600 font-semibold shadow-md hover:scale-105 transition-transform" onclick="showTab('remain')">สิทธิ์ลาคงเหลือ</button>
    <button id="tab-used" class="px-6 py-2 rounded-full bg-gray-200 text-gray-500 font-semibold hover:scale-105 transition-transform" onclick="showTab('used')">สิทธิ์ลาที่ใช้</button>
  </div>

  <!-- Content -->
  <div id="remain" class="grid gap-4"></div>
  <div id="used" class="grid gap-4 hidden"></div>

</div>

<script>
// ข้อความกำลังใจ
const motivationTexts = [
  "ยินดีต้อนรับเข้าสู่ระบบ!", "ดีใจที่เจอคุณวันนี้!", "สู้ ๆ กับวันใหม่ครับ!",
  "ขอให้วันนี้เป็นวันที่ดี!", "ยิ้มรับความท้าทายวันนี้!", "ขอให้มีความสุขกับการทำงาน!",
  "มาสำรวจสิทธิ์ลาของคุณกัน!", "วันนี้ก็ทำได้ดีแน่นอนครับ!", "เริ่มต้นวันใหม่ด้วยพลังบวกกันเถอะ!",
  "ไม่ว่าอะไรเกิดขึ้น คุณก็เอาอยู่!", "ยินดีที่ได้เจอกันอีกครั้งนะครับ!", "ขอบคุณที่ตั้งใจทำงานเสมอ!",
  "มาลุยงานกันอย่างเต็มที่เลยครับ!", "พักบ้างก็ได้นะ แต่ห้ามยอมแพ้!", "เชื่อมั่นในตัวเอง แล้วก้าวต่อไปครับ!",
  "วันนี้อาจเจอความท้าทาย แต่คุณเก่งพอ!", "ขอให้วันนี้มีรอยยิ้มเยอะ ๆ นะครับ!"
];

function getRandomMotivation() {
  return motivationTexts[Math.floor(Math.random() * motivationTexts.length)];
}

// Tabs toggle
function showTab(tab) {
  const remain = document.getElementById("remain");
  const used = document.getElementById("used");
  const tabRemain = document.getElementById("tab-remain");
  const tabUsed = document.getElementById("tab-used");

  if (tab === "remain") {
    remain.classList.remove("hidden");
    used.classList.add("hidden");
    tabRemain.classList.add("bg-white","text-blue-600","shadow-md");
    tabRemain.classList.remove("bg-gray-200","text-gray-500");
    tabUsed.classList.add("bg-gray-200","text-gray-500");
    tabUsed.classList.remove("bg-white","text-blue-600","shadow-md");
  } else {
    remain.classList.add("hidden");
    used.classList.remove("hidden");
    tabUsed.classList.add("bg-white","text-blue-600","shadow-md");
    tabUsed.classList.remove("bg-gray-200","text-gray-500");
    tabRemain.classList.add("bg-gray-200","text-gray-500");
    tabRemain.classList.remove("bg-white","text-blue-600","shadow-md");
  }
}

// Render Tabs
function renderRemainTab(data) {
  const remain = document.getElementById('remain');
  remain.innerHTML = '';
  const types = [
    {name:'ลาพักร้อน', icon:'<i class="fa-solid fa-plane-departure"></i>', value:data[2]},
    {name:'ลากิจ', icon:'<i class="fa-solid fa-person-walking-luggage"></i>', value:data[3]},
    {name:'ลาป่วย', icon:'<i class="fa-solid fa-head-side-cough"></i>', value:data[4]},
    {name:'ขาดงาน', icon:'<i class="fa-solid fa-ban"></i>', value:data[5]}
  ];
  types.forEach(t => {
    const div = document.createElement('div');
    div.className = "flex justify-between items-center bg-white p-4 rounded-2xl shadow hover:scale-102 transition-transform";
    div.innerHTML = `<div class="flex items-center space-x-3 text-xl">${t.icon}<span class="font-medium text-gray-700">${t.name}</span></div><span class="text-green-600 font-bold text-lg">${t.value} วัน</span>`;
    remain.appendChild(div);
  });
}

function renderUsedTab(data) {
  const used = document.getElementById('used');
  used.innerHTML = '';
  const types = [
    {name:'ลาพักร้อน', icon:'<i class="fa-solid fa-plane-departure"></i>', value:data[2]},
    {name:'ลากิจ', icon:'<i class="fa-solid fa-person-walking-luggage"></i>', value:data[3]},
    {name:'ลาป่วย', icon:'<i class="fa-solid fa-head-side-cough"></i>', value:data[4]},
    {name:'ขาดงาน', icon:'<i class="fa-solid fa-ban"></i>', value:data[5]}
  ];
  types.forEach(t => {
    const div = document.createElement('div');
    div.className = "flex justify-between items-center bg-white p-4 rounded-2xl shadow hover:scale-102 transition-transform";
    div.innerHTML = `<div class="flex items-center space-x-3 text-xl">${t.icon}<span class="font-medium text-gray-700">${t.name}</span></div><span class="text-red-600 font-bold text-lg">${t.value} วัน</span>`;
    used.appendChild(div);
  });
}

// Initialize dashboard
async function initializeDashboard() {
  const loading = document.getElementById('loadingScreen');
  const content = document.getElementById('dashboardContent');

  try {
    await liff.init({ liffId: "2007956727-rbZz9a0z" });
    if (!liff.isLoggedIn()) liff.login();
    const profile = await liff.getProfile();
    const lineUserId = profile.userId;

    // Fetch ข้อมูลจาก Google Apps Script
    const res = await fetch('https://script.google.com/macros/s/AKfycbweaBqP-v0PkITA_TAhRlho-UGIqP_3A4pkk8MBSTsy-Lx9u-Rh1ChCZLn7vSsXXaim/exec?lineUserId='+lineUserId);
    const data = await res.json();

    if (!data.found) {
      window.location.href = 'LineID_Registration.html';
      return;
    }

    const balanceData = data.balance; // A-F
    const recordsData = data.records; // A,B,D,E,F,G

    // แสดงโปรไฟล์
    document.getElementById('profileImage').src = profile.pictureUrl;
    document.getElementById('profileName').textContent = balanceData[1]; 
    document.getElementById('employeeCode').textContent = 'รหัสพนักงาน: ' + balanceData[0];
    document.getElementById('motivationMessage').textContent = getRandomMotivation();

    // Render Tabs
    renderRemainTab(balanceData);
    renderUsedTab(recordsData);

    // แสดง dashboard และซ่อน loading
    loading.style.display = 'none';
    content.style.display = 'block';
    content.classList.add('opacity-100');

  } catch(e) {
    console.error(e);
    alert('เกิดข้อผิดพลาดในการโหลดข้อมูล');
    loading.style.display = 'none';
  }
}

// เรียกใช้งาน
initializeDashboard();
</script>

<!-- Font Awesome -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

</body>
</html>
